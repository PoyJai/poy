<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายละเอียดเกม: Eldoria Chronicles</title>
    <!-- โหลด Tailwind CSS CDN เพื่อการออกแบบที่รวดเร็วและสวยงาม -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- กำหนดค่าเริ่มต้นของ Tailwind และใช้ฟอนต์ Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4F46E5', // Indigo-600
                        'secondary': '#F97316', // Orange-600
                        'background': '#1F2937', // Gray-800
                        'card': '#374151', // Gray-700
                    },
                    fontFamily: {
                        sans: ['Inter', 'Tahoma', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* ตั้งค่าพื้นหลังและสีข้อความพื้นฐาน */
        body {
            background-color: #1F2937;
            color: #F3F4F6;
        }
        /* สไตล์สำหรับปุ่มหลัก */
        .btn-primary {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.5), 0 4px 6px -4px rgba(79, 70, 229, 0.5);
        }
    </style>
</head>
<body>

    <!-- ส่วนหัว (Header) และแถบนำทาง (Navigation) -->
    <header class="sticky top-0 z-50 bg-background/90 backdrop-blur-sm shadow-lg">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-primary">
                AESTHETIC<span class="text-secondary">.GAMES</span>
            </div>
            <!-- Links and Auth Button -->
            <div class="hidden md:flex space-x-8 text-lg font-medium items-center">
                <a href="index.html" class="hover:text-primary transition duration-150">หน้าแรก</a>
                <a href="collection.html" class="hover:text-primary transition duration-150">เกมทั้งหมด</a>
                <a href="#" class="hover:text-primary transition duration-150">บทความ</a>
                
                <!-- Cart Button (ตำแหน่งบนขวาสำหรับ Desktop) -->
                <!-- ถูกซ่อนด้วย JS ในตอนแรกและแสดงเมื่อ AUTH สำเร็จเท่านั้น -->
                <button id="cart-button" class="relative p-2 rounded-full hover:bg-gray-700 transition duration-300 hidden" title="ตะกร้าสินค้า">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M7 18C7 19.1046 7.89543 20 9 20C10.1046 20 11 19.1046 11 18C11 16.8954 10.1046 16 9 16C7.89543 16 7 16.8954 7 18ZM17 18C17 19.1046 17.8954 20 19 20C20.1046 20 21 19.1046 21 18C21 16.8954 20.1046 16 19 16C17.8954 16 17 16.8954 17 18ZM10.5 14H18.847L21.432 5.597C21.574 5.162 21.285 4.67 20.843 4.542L5.843 1.542C5.401 1.414 4.909 1.703 4.779 2.138L1.652 12.396C1.41 13.15 1.96 13.916 2.768 14.161L10.5 14Z"/></svg>
                    <span id="cart-item-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-secondary rounded-full">0</span>
                </button>
                
                <!-- Authentication Status/Button Container -->
                <div id="auth-status-container">
                    <!-- แสดงปุ่ม Login ก่อน ถ้า Firebase ยังไม่พร้อม -->
                    <button id="auth-button" class="px-4 py-2 bg-secondary rounded-full text-white font-semibold hover:bg-orange-700 transition duration-300">เข้าสู่ระบบ / สมัคร</button>
                </div>
            </div>
            <!-- ปุ่มเมนูสำหรับมือถือ -->
            <div class="md:hidden flex items-center space-x-2">
                 <!-- Cart Button Mobile (ตำแหน่งบนขวาสำหรับ Mobile) -->
                 <button id="cart-button-mobile" class="relative p-2 rounded-lg hover:bg-card transition duration-300 hidden" title="ตะกร้าสินค้า">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M7 18C7 19.1046 7.89543 20 9 20C10.1046 20 11 19.1046 11 18C11 16.8954 10.1046 16 9 16C7.89543 16 7 16.8954 7 18ZM17 18C17 19.1046 17.8954 20 19 20C20.1046 20 21 19.1046 21 18C21 16.8954 20.1046 16 19 16C17.8954 16 17 16.8954 17 18ZM10.5 14H18.847L21.432 5.597C21.574 5.162 21.285 4.67 20.843 4.542L5.843 1.542C5.401 1.414 4.909 1.703 4.779 2.138L1.652 12.396C1.41 13.15 1.96 13.916 2.768 14.161L10.5 14Z"/></svg>
                    <span id="cart-item-count-mobile" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-secondary rounded-full">0</span>
                </button>
                <button id="menu-button" class="focus:outline-none p-2 rounded-lg hover:bg-card">
                    <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </nav>
        <!-- เมนูมือถือ (ซ่อนไว้ก่อน) -->
        <div id="mobile-menu" class="hidden md:hidden bg-card/95 py-2">
            <a href="index.html" class="block px-4 py-2 text-sm hover:bg-gray-600 transition duration-150">หน้าแรก</a>
            <a href="collection.html" class="block px-4 py-2 text-sm hover:bg-gray-600 transition duration-150">เกมทั้งหมด</a>
            <a href="index.html#categories" class="block px-4 py-2 text-sm hover:bg-gray-600 transition duration-150">หมวดหมู่</a>
            <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-600 transition duration-150">บทความ</a>
             <div id="auth-mobile-status" class="px-4 py-2">
                 <button id="auth-button-mobile" class="w-full px-4 py-2 bg-secondary rounded-full text-white font-semibold hover:bg-orange-700 transition duration-300">เข้าสู่ระบบ / สมัคร</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
        
        <!-- ข้อมูลเกมหลัก (Hero Section) -->
        <section class="bg-card p-6 md:p-10 rounded-xl shadow-2xl mb-12">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- คอลัมน์ซ้าย: ภาพและปุ่ม -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- ภาพตัวอย่าง (ใช้ Placeholder Image) -->
                    <img src="https://play-lh.googleusercontent.com/5Kqm263jKbEMe40kpjv-25AXR1pcApa7H-OVhgUf9r-8tpdu41rVRvjG1w0ELQifNW78=w526-h296-rw" 
                         alt="ภาพหน้าจอ Eldoria Chronicles" 
                         class="w-full rounded-xl shadow-lg border-4 border-primary/50">
                    
                    <!-- ปุ่มหลักสำหรับเพิ่มเข้าตะกร้า (Updated button) -->
                    <button id="purchase-button" class="w-full md:w-auto px-10 py-4 bg-secondary text-white text-xl font-bold rounded-xl btn-primary hover:bg-orange-600 transition duration-300 flex items-center justify-center space-x-2">
                        <!-- Cart Icon -->
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 2L3 6V20C3 21.1046 3.89543 22 5 22H19C20.1046 22 21 21.1046 21 20V6L18 2H6ZM6 4H18L20 7H4L6 4ZM10 10V16H14V10H10Z"/></svg>
                        <span>เพิ่มเกมนี้เข้าตะกร้า: ฿799.00</span>
                    </button>
                    
                    <p class="text-sm text-gray-400 text-center md:text-left">
                        *ราคานี้รวมภาษีมูลค่าเพิ่มแล้ว
                    </p>
                </div>

                <!-- คอลัมน์ขวา: รายละเอียดและสถิติ -->
                <div class="lg:col-span-1 space-y-6">
                    <h1 class="text-4xl font-extrabold text-white">Astral Nexus Online</h1>
                    <p class="text-lg text-primary font-semibold">MMORPG | สไตล์: แฟนตาซี / Cel-Shade</p>

                    <p class="text-gray-300 leading-relaxed">
                        เกม MMORPG ออนไลน์ที่ผู้เล่นต้องล็อกอินเพื่อสร้างตัวละครและออกสำรวจดินแดนแห่งแสงและเงา ระบบสกิลหลากหลายพร้อมอาชีพที่ปรับเปลี่ยนได้อิสระ ผู้เล่นร่วมทีมล่าบอส เปิดฉากสงครามกิลด์ และผจญภัยไปในภาพแฟนตาซีอ่อนโยนแบบ Cel-Shade ที่มอบเสน่ห์ไม่เหมือนใคร
                    </p>

                    <!-- Rating & Stats Block -->
                    <div class="bg-gray-800 p-5 rounded-lg shadow-inner border border-gray-700">
                        <div class="flex items-center space-x-2 mb-3">
                            <span class="text-5xl font-extrabold text-yellow-400">4.8</span>
                            <div class="flex flex-col">
                                <span class="text-xl font-bold text-white">ยอดเยี่ยม</span>
                                <span class="text-sm text-gray-400">คะแนนเฉลี่ยจาก 1,200 รีวิว</span>
                            </div>
                        </div>
                        <hr class="border-gray-700 my-4">
                        <div class="space-y-2 text-sm">
                            <p><strong>ผู้พัฒนา:</strong> Aesthetic Studio</p>
                            <p><strong>วันที่เผยแพร่:</strong> 15 มกราคม 2025</p>
                            <p><strong>แพลตฟอร์ม:</strong> Web Browser, Mobile (Mock-up)</p>
                            <p><strong>ราคา:</strong> <span class="text-green-400 font-bold">฿399.00</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ส่วนรีวิวและความคิดเห็น -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-2">ความคิดเห็นจากผู้เล่น</h2>
            
            <div id="reviews-container" class="space-y-6">
                <!-- Review Mock-up 1 -->
                <div class="bg-card p-6 rounded-lg shadow-lg border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-lg text-primary">นักสำรวจแห่งเงา</span>
                        <span class="text-yellow-400 font-bold">5.0 ⭐</span>
                    </div>
                    <p class="text-gray-300">"ภาพวาดสีน้ำสวยงามมาก เนื้อเรื่องลึกซึ้ง และเพลงประกอบก็เยี่ยมที่สุด ทำให้รู้สึกเหมือนได้หลุดเข้าไปอยู่ในโลกแห่งเทพนิยายจริงๆ"</p>
                </div>
                
                <!-- Review Mock-up 2 -->
                <div class="bg-card p-6 rounded-lg shadow-lg border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-lg text-secondary">ผู้เล่นมือใหม่</span>
                        <span class="text-yellow-400 font-bold">4.5 ⭐</span>
                    </div>
                    <p class="text-gray-300">"เป็นเกม RPG ที่ยอดเยี่ยม แต่ระบบต่อสู้อาจจะช้าไปนิดสำหรับผู้เล่นบางคน แต่โดยรวมแล้วคุ้มค่าที่จะเล่นมาก"</p>
                </div>
                
                <!-- Review Input Placeholder -->
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <h3 class="text-xl font-bold text-white mb-4">เขียนรีวิวของคุณ</h3>
                    <textarea id="review-text" rows="4" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-primary focus:border-primary" placeholder="แบ่งปันความคิดเห็นของคุณเกี่ยวกับเกมนี้..."></textarea>
                    <div class="flex justify-between items-center mt-3">
                        <select class="p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            <option>5 ดาว</option>
                            <option>4 ดาว</option>
                            <option>3 ดาว</option>
                            <option>2 ดาว</option>
                            <option>1 ดาว</option>
                        </select>
                        <button class="px-6 py-2 bg-primary text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-300">ส่งรีวิว</button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- ส่วนท้าย (Footer) -->
    <footer class="bg-card border-t border-gray-700 mt-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center text-gray-400">
            <div class="flex flex-col md:flex-row justify-center space-y-2 md:space-y-0 md:space-x-8 mb-4">
                <a href="#" class="hover:text-primary transition duration-150">นโยบายความเป็นส่วนตัว</a>
                <a href="#" class="hover:text-primary transition duration-150">ข้อกำหนดการใช้งาน</a>
            </div>
            <p>&copy; 2025 โลกแห่งเกมอันงดงาม (AESTHETIC.GAMES) | สงวนลิขสิทธิ์</p>
        </div>
    </footer>

    <!-- Global Temporary Message Box -->
    <div id="temp-message-box" class="fixed bottom-4 right-4 z-[120] p-4 rounded-lg shadow-xl text-white font-semibold hidden transition-opacity duration-300 opacity-0"></div>


    <!-- Auth Modal Container (หน้าต่างสำหรับ Login/Signup) -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[100] hidden flex items-center justify-center p-4">
        <!-- Modal Content -->
        <div class="bg-card w-full max-w-md p-6 rounded-xl shadow-2xl relative border border-primary/50">
            <button id="close-modal-button" class="absolute top-4 right-4 text-gray-400 hover:text-white transition duration-150">
                <!-- Close icon -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <h2 id="auth-title" class="text-3xl font-bold text-primary mb-6 text-center">เข้าสู่ระบบ</h2>
            <!-- Error Message Box -->
            <p id="auth-error-message" class="text-sm bg-red-900/50 text-red-300 border border-red-700 p-3 rounded-lg mb-4 hidden"></p>

            <!-- Form -->
            <form id="auth-form">
                <!-- Email Input -->
                <div class="mb-4">
                    <label for="auth-email" class="block text-sm font-medium text-gray-300 mb-2">อีเมล</label>
                    <input type="email" id="auth-email" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-primary focus:border-primary text-white" placeholder="you@example.com">
                </div>
                <!-- Password Input -->
                <div class="mb-6">
                    <label for="auth-password" class="block text-sm font-medium text-gray-300 mb-2">รหัสผ่าน</label>
                    <input type="password" id="auth-password" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-primary focus:border-primary text-white" placeholder="********">
                </div>
                
                <!-- Submit Button (Text changes based on mode) -->
                <button type="submit" id="submit-auth-button" class="w-full btn-primary bg-primary hover:bg-indigo-700 text-white font-bold py-3 rounded-lg">เข้าสู่ระบบ</button>
            </form>

            <!-- Toggle Mode -->
            <div class="mt-6 text-center">
                <p id="toggle-auth-text" class="text-gray-400 text-sm">ยังไม่มีบัญชี? 
                    <button type="button" id="toggle-auth-mode" class="text-secondary hover:text-orange-400 font-medium">สมัครสมาชิก</button>
                </p>
            </div>
            
            <div class="mt-4 text-xs text-center text-gray-500">
                <p>รหัสผู้ใช้ (User ID): <span id="current-user-id" class="font-mono text-primary text-xs break-all">-- N/A --</span></p>
            </div>
        </div>
    </div>
    
    <!-- Cart Modal Container (New Z-index 105) -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[105] hidden flex items-center justify-center p-4">
        <!-- Modal Content -->
        <div class="bg-card w-full max-w-2xl p-6 rounded-xl shadow-2xl relative border border-primary/50">
            <button id="close-cart-modal-button" class="absolute top-4 right-4 text-gray-400 hover:text-white transition duration-150">
                <!-- Close icon -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <h2 class="text-3xl font-bold text-primary mb-6">ตะกร้าสินค้าของคุณ</h2>
            
            <div id="cart-items-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                <!-- Cart items will be rendered here -->
                <p class="text-gray-400 text-center py-8" id="empty-cart-message">ตะกร้าว่างเปล่า</p>
            </div>
            
            <div class="mt-6 pt-4 border-t border-gray-700">
                <div class="flex justify-between items-center text-xl font-bold mb-4">
                    <span>ราคารวมทั้งหมด:</span>
                    <span id="cart-total" class="text-secondary">฿0.00</span>
                </div>
                
                <button id="cart-checkout-button" class="w-full px-4 py-3 bg-secondary text-white text-lg font-bold rounded-lg btn-primary hover:bg-orange-600 transition duration-300 disabled:opacity-50" disabled>
                    ดำเนินการชำระเงิน
                </button>
            </div>
        </div>
    </div>

    
    <!-- Payment Modal Container (Z-index 110) -->
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[110] hidden flex items-center justify-center p-4">
        <!-- Modal Content -->
        <div class="bg-card w-full max-w-lg p-8 rounded-xl shadow-2xl relative border border-secondary/50">
            <button id="close-payment-modal-button" class="absolute top-4 right-4 text-gray-400 hover:text-white transition duration-150">
                <!-- Close icon -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <h2 class="text-3xl font-bold text-secondary mb-6 text-center">ยืนยันการซื้อ: สินค้าในตะกร้า</h2>
            
            <div class="space-y-4">
                <p class="text-2xl font-semibold text-white text-center">ราคารวม: <span id="payment-total-amount" class="text-green-400">฿0.00</span></p>
                <p class="text-gray-400 text-center">กรุณาเลือกวิธีการชำระเงิน (ระบบ Mock-up)</p>
                
                <!-- Payment Method Mock-up -->
                <div class="bg-gray-800 p-4 rounded-lg space-y-3">
                    <label class="flex items-center space-x-3 bg-gray-700 p-3 rounded-lg cursor-pointer hover:bg-gray-600 border border-gray-700 hover:border-primary transition">
                        <input type="radio" name="payment_method" value="credit_card" checked class="form-radio text-primary ring-primary">
                        <span class="text-white font-medium flex-grow">บัตรเครดิต/เดบิต</span>
                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M18 4H6C4.89543 4 4 4.89543 4 6V18C4 19.1046 4.89543 20 6 20H18C19.1046 20 20 19.1046 20 18V6C20 4.89543 19.1046 4 18 4ZM6 12V8H18V12H6ZM6 16H18V18H6V16Z"/></svg>
                    </label>
                    <label class="flex items-center space-x-3 bg-gray-700 p-3 rounded-lg cursor-pointer hover:bg-gray-600 border border-gray-700 hover:border-primary transition">
                        <input type="radio" name="payment_method" value="prompt_pay" class="form-radio text-primary ring-primary">
                        <span class="text-white font-medium flex-grow">พร้อมเพย์ / QR Code</span>
                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V5C21 3.89543 20.1046 3 19 3ZM10 16H8V14H10V16ZM10 12H8V10H10V12ZM14 16H12V14H14V16ZM14 12H12V10H14V12ZM18 16H16V14H18V16ZM18 12H16V10H18V12Z"/></svg>
                    </label>
                </div>
                
                <!-- Purchase Button -->
                <button id="complete-purchase-button" class="w-full mt-6 px-4 py-3 bg-primary text-white text-lg font-bold rounded-lg btn-primary hover:bg-indigo-700 transition duration-300">
                    ดำเนินการชำระเงิน (Mock)
                </button>
            </div>

            <!-- Purchase Status Message -->
            <div id="purchase-status" class="mt-4 p-4 rounded-lg text-center hidden font-semibold"></div>

        </div>
    </div>

    <!-- Firebase SDK Imports และ Game Logic Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // กำหนดให้ Firebase แสดง log ในโหมด Debug
        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let isSignUpMode = false; // สถานะปัจจุบันของ Modal: false=Login, true=Signup
        let cartUnsubscribe = null; // สำหรับยกเลิก listener ของตะกร้า
        let isAuthReady = false; // สถานะใหม่: เพื่อติดตามว่า Auth ได้ตรวจสอบสถานะเริ่มต้นแล้ว
        
        // --- Game & Cart Details ---
        const currentGameId = 'EldoriaChronicles_001';
        const currentGamePrice = 399.00;
        const gameDetails = {
            id: currentGameId,
            name: 'Eldoria Chronicles',
            price: currentGamePrice
        };
        let cartItems = {}; // Local state for cart items (map: gameId -> item)

        // --- DOM Elements ---
        const authModal = document.getElementById('auth-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const authTitle = document.getElementById('auth-title');
        const authForm = document.getElementById('auth-form');
        const submitAuthButton = document.getElementById('submit-auth-button');
        const authErrorMessage = document.getElementById('auth-error-message');
        const currentUserIdElement = document.getElementById('current-user-id');
        const authStatusContainer = document.getElementById('auth-status-container');
        const authMobileStatus = document.getElementById('auth-mobile-status');
        const tempMessageBox = document.getElementById('temp-message-box');
        
        // --- Cart DOM Elements (New) ---
        const cartButton = document.getElementById('cart-button');
        const cartButtonMobile = document.getElementById('cart-button-mobile');
        const purchaseButton = document.getElementById('purchase-button'); // Now "Add to Cart"
        const cartModal = document.getElementById('cart-modal');
        const closeCartModalButton = document.getElementById('close-cart-modal-button');
        const cartItemsList = document.getElementById('cart-items-list');
        const cartTotalElement = document.getElementById('cart-total');
        const cartCheckoutButton = document.getElementById('cart-checkout-button');
        
        // --- Payment DOM Elements ---
        const paymentModal = document.getElementById('payment-modal');
        const closePaymentModalButton = document.getElementById('close-payment-modal-button');
        const completePurchaseButton = document.getElementById('complete-purchase-button');
        const purchaseStatus = document.getElementById('purchase-status');
        const paymentTotalAmount = document.getElementById('payment-total-amount');


        // --- Firebase Utilities ---

        const getUserCartDocRef = (userId) => {
            // Path: artifacts/{appId}/users/{userId}/cart/items
            return doc(db, `artifacts/${appId}/users/${userId}/cart`, 'items');
        };

        const showTemporaryMessage = (message, type) => {
            const classes = {
                'success': 'bg-green-600',
                'error': 'bg-red-600',
                'info': 'bg-blue-600'
            };

            tempMessageBox.textContent = message;
            tempMessageBox.className = 'fixed bottom-4 right-4 z-[120] p-4 rounded-lg shadow-xl text-white font-semibold transition-opacity duration-300 opacity-0 ' + classes[type];
            tempMessageBox.classList.remove('hidden', 'opacity-0');
            tempMessageBox.classList.add('opacity-100');

            setTimeout(() => {
                tempMessageBox.classList.remove('opacity-100');
                tempMessageBox.classList.add('opacity-0');
                setTimeout(() => {
                    tempMessageBox.classList.add('hidden');
                }, 300);
            }, 3000);
        };

        // --- Firebase Initialization and Authentication ---

        const initializeFirebase = async () => {
            try {
                // Initialize only if firebaseConfig is not empty
                if (Object.keys(firebaseConfig).length === 0) {
                     console.error("Firebase config is missing. Running without cloud features.");
                     handleAuthStateChanged(null); // Treat as signed out for local testing purposes
                     return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set up the listener first
                onAuthStateChanged(auth, handleAuthStateChanged);

                // Then try to sign in
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Sign in anonymously if no custom token is provided (local run or new user)
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Initialization or Sign-In Error:", error);
                displayError(`เกิดข้อผิดพลาดในการเชื่อมต่อ: ${error.message}`);
                handleAuthStateChanged(null);
            }
        };

        const handleAuthStateChanged = (user) => {
            isAuthReady = true; // Auth state has been checked at least once
            
            if (user) {
                const userId = user.uid;
                currentUserIdElement.textContent = userId;
                updateHeaderForSignedInUser(user);
                listenToCartChanges(userId); // Start listening to cart
                
                if (user.email) {
                    createOrUpdateUserProfile(userId, user.email);
                }
            } else {
                currentUserIdElement.textContent = '-- N/A --';
                updateHeaderForSignedOutUser();
                if (cartUnsubscribe) {
                    cartUnsubscribe(); // Stop listening if user signs out
                }
                cartItems = {}; // Clear local cart state
                updateCartCounter();
            }
        };
        
        const createOrUpdateUserProfile = async (userId, email) => {
             // Mock-up Firestore interaction (Private data)
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'details');
            try {
                await setDoc(userDocRef, { 
                    email: email, 
                    lastLogin: new Date().toISOString()
                }, { merge: true });
            } catch (error) {
                console.error("Error creating/updating user profile:", error);
            }
        };

        const updateHeaderForSignedInUser = (user) => {
            const displayName = user.email ? user.email.split('@')[0] : 'ผู้ใช้';
            
            // Desktop/Tablet Auth
            authStatusContainer.innerHTML = `
                <div class="flex items-center space-x-4">
                    <span class="text-sm font-medium text-primary">สวัสดี, ${displayName}</span>
                    <button id="sign-out-button" class="px-4 py-2 bg-gray-600 rounded-full text-white font-semibold hover:bg-gray-700 transition duration-300">ออกจากระบบ</button>
                </div>
            `;
            // Mobile Auth
            authMobileStatus.innerHTML = `
                <div class="text-sm font-medium text-primary mb-2 text-center">สวัสดี, ${displayName}</div>
                <button id="sign-out-button-mobile" class="w-full px-4 py-2 bg-gray-600 rounded-full text-white font-semibold hover:bg-gray-700 transition duration-300">ออกจากระบบ</button>
            `;
            
            document.getElementById('sign-out-button')?.addEventListener('click', handleSignOut);
            document.getElementById('sign-out-button-mobile')?.addEventListener('click', handleSignOut);
            
            // --- CRITICAL: Show cart buttons now that the user is authenticated ---
            cartButton.classList.remove('hidden');
            cartButtonMobile.classList.remove('hidden');
        };

        const updateHeaderForSignedOutUser = () => {
            // Desktop/Tablet Auth
            authStatusContainer.innerHTML = `
                <button id="auth-button" class="px-4 py-2 bg-secondary rounded-full text-white font-semibold hover:bg-orange-700 transition duration-300">เข้าสู่ระบบ / สมัคร</button>
            `;
             // Mobile Auth
            authMobileStatus.innerHTML = `
                <button id="auth-button-mobile" class="w-full px-4 py-2 bg-secondary rounded-full text-white font-semibold hover:bg-orange-700 transition duration-300">เข้าสู่ระบบ / สมัคร</button>
            `;
            
            // Re-attach listeners for sign-in
            document.getElementById('auth-button')?.addEventListener('click', () => openAuthModal('login'));
            document.getElementById('auth-button-mobile')?.addEventListener('click', () => openAuthModal('login'));

            // --- CRITICAL: Hide cart buttons when signed out ---
            cartButton.classList.add('hidden');
            cartButtonMobile.classList.add('hidden');
        };
        
        const handleSignOut = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign Out Error:", error);
            }
        };

        // --- Auth Modal Logic (Unchanged) ---
        
        const toggleAuthMode = () => {
            isSignUpMode = !isSignUpMode;
            if (isSignUpMode) {
                authTitle.textContent = 'สมัครสมาชิก';
                submitAuthButton.textContent = 'สมัครสมาชิก';
                document.getElementById('toggle-auth-text').innerHTML = 'มีบัญชีอยู่แล้ว? <button type="button" id="toggle-auth-mode" class="text-secondary hover:text-orange-400 font-medium">เข้าสู่ระบบ</button>';
            } else {
                authTitle.textContent = 'เข้าสู่ระบบ';
                submitAuthButton.textContent = 'เข้าสู่ระบบ';
                document.getElementById('toggle-auth-text').innerHTML = 'ยังไม่มีบัญชี? <button type="button" id="toggle-auth-mode" class="text-secondary hover:text-orange-400 font-medium">สมัครสมาชิก</button>';
            }
            document.getElementById('toggle-auth-mode').addEventListener('click', toggleAuthMode);
            hideError();
        };

        const openAuthModal = (mode = 'login') => {
            isSignUpMode = (mode === 'signup');
            toggleAuthMode();
            authModal.classList.remove('hidden');
        };

        const closeAuthModal = () => {
            authModal.classList.add('hidden');
            authForm.reset();
            hideError();
        };

        const displayError = (message) => {
            authErrorMessage.textContent = message;
            authErrorMessage.classList.remove('hidden');
        };

        const hideError = () => {
            authErrorMessage.classList.add('hidden');
            authErrorMessage.textContent = '';
        };
        
        const handleAuthSubmit = async (e) => {
            e.preventDefault();
            hideError();
            
            if (!isAuthReady) {
                displayError('ระบบกำลังเตรียมความพร้อม กรุณาลองใหม่ในไม่ช้า');
                return;
            }

            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;

            submitAuthButton.disabled = true;
            submitAuthButton.textContent = isSignUpMode ? 'กำลังสมัคร...' : 'กำลังเข้าสู่ระบบ...';

            try {
                if (isSignUpMode) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                
                closeAuthModal();

            } catch (error) {
                console.error("Authentication Error:", error);
                let errorMessage;
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'อีเมลนี้ถูกใช้ในการสมัครแล้ว';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'รูปแบบอีเมลไม่ถูกต้อง';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร';
                        break;
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = 'อีเมลหรือรหัสผ่านไม่ถูกต้อง';
                        break;
                    default:
                        errorMessage = `เกิดข้อผิดพลาด: ${error.message}`;
                }
                displayError(errorMessage);
            } finally {
                submitAuthButton.disabled = false;
                submitAuthButton.textContent = isSignUpMode ? 'สมัครสมาชิก' : 'เข้าสู่ระบบ';
            }
        };


        // --- Cart Functions ---

        const listenToCartChanges = (userId) => {
            // ไม่ต้องรันถ้า Firebase ไม่ได้ถูกตั้งค่า (สำหรับกรณีรัน Local ที่ config เป็นค่าว่าง)
            if (!userId || !db) return; 

            if (cartUnsubscribe) {
                cartUnsubscribe(); // Stop existing listener if any
            }
            
            const cartDocRef = getUserCartDocRef(userId);
            cartUnsubscribe = onSnapshot(cartDocRef, (docSnapshot) => {
                if (docSnapshot.exists() && Object.keys(docSnapshot.data()).length > 0) {
                    // Cart data is a map of item objects
                    cartItems = docSnapshot.data();
                    renderCartModal();
                    updateCartCounter();
                } else {
                    cartItems = {};
                    renderCartModal();
                    updateCartCounter();
                }
            }, (error) => {
                console.error("Error listening to cart changes:", error);
            });
        };

        const updateCartCounter = () => {
            const totalItems = Object.keys(cartItems).length;
            const countText = totalItems > 0 ? totalItems : 0;
            
            // Desktop (top right)
            document.getElementById('cart-item-count').textContent = countText;
            
            // Mobile (top right)
            document.getElementById('cart-item-count-mobile').textContent = countText;
            
            // Check if cart buttons should be visible (only visible when authenticated)
            const userIsAuthenticated = auth?.currentUser?.uid;
            
            cartButton.classList.toggle('hidden', !userIsAuthenticated);
            cartButtonMobile.classList.toggle('hidden', !userIsAuthenticated);
        };

        const openCartModal = () => {
            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                showTemporaryMessage('กรุณาเข้าสู่ระบบเพื่อใช้ตะกร้าสินค้า', 'info');
                openAuthModal('login');
                return;
            }
            renderCartModal();
            cartModal.classList.remove('hidden');
        };

        const closeCartModal = () => {
            cartModal.classList.add('hidden');
        };

        const addToCart = async () => {
            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                showTemporaryMessage('กรุณาเข้าสู่ระบบเพื่อเพิ่มสินค้าในตะกร้า', 'info');
                openAuthModal('login');
                return;
            }

            if (!db) {
                 showTemporaryMessage('การเชื่อมต่อฐานข้อมูลไม่พร้อม', 'error');
                 return;
            }

            const userId = auth.currentUser.uid;
            
            // Check if game is already in cart, if so, we won't add it again (one game per purchase)
            if (cartItems[currentGameId]) {
                 showTemporaryMessage('เกมนี้อยู่ในตะกร้าสินค้าแล้ว!', 'info');
                 openCartModal();
                 return;
            }

            const item = { ...gameDetails, addedAt: new Date().toISOString() };

            const cartDocRef = getUserCartDocRef(userId);
            const update = {};
            update[currentGameId] = item;

            try {
                // Use setDoc with merge: true to add or update items without overwriting the whole map
                await setDoc(cartDocRef, update, { merge: true });
                showTemporaryMessage(`เพิ่ม "${gameDetails.name}" เข้าตะกร้าแล้ว!`, 'success');
            } catch (error) {
                console.error("Error adding to cart:", error);
                showTemporaryMessage('เกิดข้อผิดพลาดในการเพิ่มเข้าตะกร้า.', 'error');
            }
        };
        
        const removeFromCart = async (gameId, gameName) => {
            if (!auth.currentUser || auth.currentUser.isAnonymous) return;
            if (!db) return;

            const userId = auth.currentUser.uid;
            const cartDocRef = getUserCartDocRef(userId);
            
            const update = {};
            // Use deleteField to remove the specific gameId key from the map
            update[gameId] = deleteField();
            
            try {
                await updateDoc(cartDocRef, update);
                showTemporaryMessage(`นำ "${gameName}" ออกจากตะกร้าแล้ว`, 'info');
            } catch (error) {
                console.error("Error removing from cart:", error);
                showTemporaryMessage('เกิดข้อผิดพลาดในการลบออกจากตะกร้า.', 'error');
            }
        };
        
        const renderCartModal = () => {
            const itemKeys = Object.keys(cartItems);
            let total = 0;
            
            // Clear current list
            cartItemsList.innerHTML = '';

            if (itemKeys.length === 0) {
                cartItemsList.innerHTML = '<p class="text-gray-400 text-center py-8" id="empty-cart-message">ตะกร้าว่างเปล่า</p>';
                cartCheckoutButton.disabled = true;
                cartTotalElement.textContent = '฿0.00';
                return;
            }
            
            cartCheckoutButton.disabled = false;
            
            itemKeys.forEach(key => {
                const item = cartItems[key];
                const itemTotal = item.price; // Assuming quantity is 1 for games
                total += itemTotal;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-gray-700 p-4 rounded-lg shadow-md';
                itemDiv.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <svg class="w-8 h-8 text-primary flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2ZM11 16V12H8V10H11V7L16 11.5L11 16Z"/></svg>
                        <div class="flex flex-col">
                            <span class="font-bold text-white">${item.name}</span>
                            <span class="text-sm text-gray-400">ราคาต่อชิ้น: ฿${item.price.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="font-bold text-lg text-green-400 flex-shrink-0">฿${itemTotal.toFixed(2)}</span>
                        <button data-game-id="${key}" data-game-name="${item.name}" class="remove-from-cart-btn p-2 bg-red-600 rounded-full text-white hover:bg-red-700 transition duration-300 flex-shrink-0" title="ลบออก">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                cartItemsList.appendChild(itemDiv);
            });
            
            cartTotalElement.textContent = `฿${total.toFixed(2)}`;
            
            // Re-attach listeners for remove buttons
            document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const gameId = e.currentTarget.getAttribute('data-game-id');
                    const gameName = e.currentTarget.getAttribute('data-game-name');
                    removeFromCart(gameId, gameName);
                });
            });
        };


        // --- Payment Functions (Modified) ---

        const openPaymentModal = () => {
            // Must check cart status before proceeding
            const totalItemsInCart = Object.keys(cartItems).length;
            if (totalItemsInCart === 0) {
                showTemporaryMessage('ตะกร้าสินค้าว่างเปล่า กรุณาเพิ่มสินค้าก่อนชำระเงิน', 'info');
                closeCartModal();
                return;
            }
            
            // Set the total amount based on the current cart total
            const total = Object.values(cartItems).reduce((sum, item) => sum + item.price, 0);

            // Update Payment Modal UI
            paymentTotalAmount.textContent = `฿${total.toFixed(2)}`;
            document.querySelector('#payment-modal h2').textContent = `ยืนยันการซื้อ ${totalItemsInCart} รายการ`;
            
            // Reset status and button
            purchaseStatus.classList.add('hidden');
            purchaseStatus.textContent = '';
            purchaseStatus.classList.remove('bg-green-900/50', 'bg-red-900/50', 'text-green-300', 'text-red-300', 'bg-primary/50');
            completePurchaseButton.disabled = false;
            completePurchaseButton.textContent = 'ดำเนินการชำระเงิน (Mock)';
            completePurchaseButton.onclick = () => handlePurchase(total); // Pass the total amount
            
            closeCartModal(); // Close cart modal
            paymentModal.classList.remove('hidden');
        };

        const closePaymentModal = () => {
            paymentModal.classList.add('hidden');
        };

        const handlePurchase = async (totalAmount) => {
            completePurchaseButton.disabled = true;
            completePurchaseButton.textContent = 'กำลังดำเนินการ...';
            
            // 1. Show processing message
            purchaseStatus.classList.remove('hidden', 'bg-red-900/50', 'bg-green-900/50');
            purchaseStatus.classList.add('bg-primary/50', 'text-white');
            purchaseStatus.innerHTML = `กำลังจำลองการชำระเงิน ฿${totalAmount.toFixed(2)}...`;

            // 2. Simulate Network Delay
            await new Promise(resolve => setTimeout(resolve, 2000));

            // 3. Mock successful transaction
            const success = Math.random() < 0.9; // 90% success rate

            if (success) {
                purchaseStatus.classList.remove('bg-primary/50');
                purchaseStatus.classList.add('bg-green-900/50', 'text-green-300');
                purchaseStatus.innerHTML = '✅ การชำระเงินสำเร็จ! ขอบคุณสำหรับการซื้อ<br>สินค้าจะถูกเพิ่มเข้าสู่บัญชีของคุณ';
                
                // Clear the cart in Firestore after successful purchase (Crucial step)
                const userId = auth.currentUser.uid;
                const cartDocRef = getUserCartDocRef(userId);
                try {
                    await setDoc(cartDocRef, {}); // Clears all items
                } catch (e) {
                    console.error("Failed to clear cart after purchase:", e);
                }

                // Change button function to "View Library"
                completePurchaseButton.textContent = 'ไปยังหน้าคลังเกม (View Library)';
                completePurchaseButton.onclick = () => {
                    // Navigate to a mock library page
                    window.location.href = "index.html?view=library"; 
                };

            } else {
                // Mock failed transaction
                purchaseStatus.classList.remove('bg-primary/50');
                purchaseStatus.classList.add('bg-red-900/50', 'text-red-300');
                completePurchaseButton.textContent = 'ลองชำระเงินอีกครั้ง';
                purchaseStatus.innerHTML = '❌ การชำระเงินล้มเหลว กรุณาลองใหม่อีกครั้ง';
                completePurchaseButton.disabled = false;
                
            }
        };


        // --- Main Initialization and Event Listeners ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialize Firebase and Auth (This is an async process)
            initializeFirebase();

            // 2. Set up event listeners for the mobile menu
            const menuButton = document.getElementById('menu-button');
            const mobileMenu = document.getElementById('mobile-menu');

            menuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });

            // 3. Set up Auth Modal event listeners 
            closeModalButton.addEventListener('click', closeAuthModal);
            document.getElementById('toggle-auth-mode').addEventListener('click', toggleAuthMode);
            authForm.addEventListener('submit', handleAuthSubmit);

            authModal.addEventListener('click', (e) => {
                if (e.target === authModal) {
                    closeAuthModal();
                }
            });
            
            // 4. Set up Cart Listeners
            purchaseButton.addEventListener('click', addToCart);
            cartButton.addEventListener('click', openCartModal);
            cartButtonMobile.addEventListener('click', openCartModal);
            closeCartModalButton.addEventListener('click', closeCartModal);
            cartCheckoutButton.addEventListener('click', openPaymentModal);
            
            cartModal.addEventListener('click', (e) => {
                if (e.target === cartModal) {
                    closeCartModal();
                }
            });
            
            // 5. Set up Payment Modal Listeners
            closePaymentModalButton.addEventListener('click', closePaymentModal);
            
            paymentModal.addEventListener('click', (e) => {
                if (e.target === paymentModal) {
                    closePaymentModal();
                }
            });

            // 6. Ensure initial auth buttons are clickable immediately
            document.getElementById('auth-button')?.addEventListener('click', () => openAuthModal('login'));
            document.getElementById('auth-button-mobile')?.addEventListener('click', () => openAuthModal('login'));
        });
    </script>
</body>
</html>